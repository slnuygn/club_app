rules_version = '2';


service cloud.firestore {

  match /databases/{database}/documents {


    // Allow anyone to read from the 'clubs' collection.

    // When creating a new club, it must contain only 'club_name', 'club_photo_URL', and 'club_bio'.

    match /clubs/{clubId} {

      allow read: if true;

      allow create: if request.resource.data.keys().hasOnly([

        'club_name',

        'club_photo_URL',

        'club_bio'

      ]);

      allow update: if
        request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_key == clubId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_rank == 'President';

    }


    // Allow anyone to read from the 'posts' collection.

    // To create a post, the user must be authenticated, the club_id must exist,

    // and the user's club_key must match the post's club_id.

    match /posts/{postId} {

      allow read: if true;

      allow create: if

        request.resource.data.keys().hasOnly([

          'club_id',

          'event_date',

          'event_location_URL',

          'event_placeholder',

          'photo_URL',

          'post_caption',

          'state'

        ]) &&

        exists(/databases/$(database)/documents/clubs/$(request.resource.data.club_id)) &&

        request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_key == request.resource.data.club_id &&

        (

          // Presidents and Co-Presidents can create approved posts

          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_rank in ['President', 'Co-President'] &&

           request.resource.data.state == 'approved') ||

          // Others must create pending posts

          (request.resource.data.state == 'pending')

        );


      // Allow club members (President, Co-President, Board) to update post state

      allow update: if

        request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_key == resource.data.club_id &&

        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_rank in ['President', 'Co-President', 'Board'] &&

        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['state']) &&

        request.resource.data.state in ['approved', 'rejected'];


      // Allow club members to delete their own club's posts

      allow delete: if

        request.auth != null &&

        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_key == resource.data.club_id &&

        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_rank in ['President', 'Co-President', 'Board'];

    }


    // Rules for the 'users' collection:

    match /users/{userId} {

      // Users can read any user document if authenticated (for search functionality)
      allow read: if request.auth != null;

      // Users can only read their own user document (original rule, now redundant but kept for clarity)
      // allow read: if request.auth != null && request.auth.uid == userId;


      // When a user signs in and their document is created,

      // the document ID must be their UID and it must contain ONLY the specified fields.

      allow create: if

        request.auth != null &&

        request.auth.uid == userId &&

        request.resource.data.keys().hasOnly([

          'club_key',

          'club_rank',

          'following_clubs',

          'liked_posts',

          'name',

          'notifications',

          'profile_photo_URL'

        ]);


      // Users can update their own user document, but only for the specified fields.

      allow update: if

          request.auth != null &&

          request.auth.uid == userId &&

          request.resource.data.diff(resource.data).affectedKeys().hasOnly([

            'following_clubs',

            'liked_posts',

            'name',

            'notifications',

            'profile_photo_URL'

          ]);


      // Allow club leaders (President, Co-President, Board) to grant/revoke membership

      // They can update another user's club_key and club_rank

      allow update: if

          request.auth != null &&

          request.auth.uid != userId && // Not updating their own document

          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.club_rank in ['President', 'Co-President', 'Board'] &&

          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['club_key', 'club_rank', 'notifications']);

    }

  }

}
